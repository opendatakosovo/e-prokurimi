{% extends "base.html" %}
{% block body %}
<style type="text/css">
  .redflagInfo{
    color:#2c3e50;
    float:right;
  }

  .redflagInfo:hover{
    text-decoration: underline;
    color: blue;
    cursor: pointer;
  }
</style>
<link href="https://cdn.datatables.net/1.10.7/css/jquery.dataTables.css" rel="stylesheet">
<script type="text/javascript" src="{{ url_for('static', filename='redFlags.js') }}"></script>
<script type="text/javascript">

      google.load("visualization", "1", {packages:["table"]});
      
      $(document).ready(function(){

        $( "#btn_red_flag_info" ).click(function() {
                $( "#jqueryUI" ).dialog({
                   draggable: false,
                   autoOpen: false, 
                   resizable: false,
                   hide: "slide",
                   show : "slide",
                   position: {my: "top", at: "top+100", of: window},
                   closeOnEscape: true,
                   width: 700      
                });
                $( "#jqueryUI" ).empty();
                $( "#jqueryUI" ).append('Kontrata hijëzohet me të kuqe atëherë kur: ');

                $( "#jqueryUI" ).append('<ul>');
                for (var i = 0; i< redFlags.length; i++) {
                  $( "#jqueryUI" ).append('<li>' + redFlags[i] + '</li>');
                }
                $( "#jqueryUI" ).append('</ul>');
                
                $( "#jqueryUI" ).dialog('open');
            });


        var url = '{{ config.BASE_PATH }}/json/{{ komuna }}/red-flags/'+ '2013';
        $.get(url, function(){
        }).done(function(jsonResult){
            buildTable(jsonResult, '2013');
            $('#results_2013').dataTable({
              "paging": true,
              "pagingType": "full_numbers"
            });
        });

        $('#viti-select').on("change", function(event){
          var year_get = $('#viti-select').val();
          var url_get = '{{ config.BASE_PATH }}/json/{{ komuna }}/red-flags/'+ year_get;
          $.get(url_get, function(){
          }).done(function(results, year_get){
            buildTable(results, year_get);
            // Some time later, recreate with just filtering (no scrolling)
            $('#results_' + year_get).dataTable({
              "paging": true,
              "pagingType": "full_numbers"
            });
          });
        });
      });
      

      function buildTable(jsonResult, year){
      var redFlagTrackerArray = new Array();
        var totali = 0;
        var red_flags_number;
        var row_index = 0;
        $('#table').empty();
        $('#table').append("<table id='results_"+ year +"' class='display' cellspacing='0' width='100%'><thead><tr><th class='td-head'>Kompania</th><th class='td-head'>Selia</th><th style='font-size: 13px; font-weight:bold; width:500px;'>Aktiviteti</th><th class='td-head'>Vlera e paraparë</th><th class='td-head'>Vlera e kontraktuar</th><th class='td-head'>Aneks</th><th class='td-head'>Vlera e kontraktuar + Aneks</th></tr></thead><tbody class='table-body' id='red-flags-table-"+year+"'></tbody></table>");
        var totali_vlera = 0;
        var totali_qmimi = 0;
        var totali_aneks = 0; 
        var totali_total = 0;
        for ( var key in jsonResult ){
          totali = jsonResult[key].qmimi + jsonResult[key].qmimiAneks;
          totali_vlera = totali_vlera + jsonResult[key].vlera;
          totali_qmimi = totali_qmimi + jsonResult[key].qmimi;
          totali_aneks = totali_aneks + jsonResult[key].qmimiAneks;
          totali_total = totali_total + totali;
          $('#red-flags-table-' + year).append("<tr id='"+ row_index +"'>" +
            "<td class='td-body'>"+jsonResult[key].kompania+"</td>"+
            "<td class='td-body'>"+jsonResult[key].selia+"</td>"+
            "<td style='font-size: 13px; width:500px;'>"+jsonResult[key].pershkrimi+"</td>"+
            "<td value='"+ jsonResult[key].vlera + "' class='td-body1'>"+toCurrency(jsonResult[key].vlera, 1)+"</td>"+
            "<td value='"+ jsonResult[key].qmimi + "' class='td-body2'>"+toCurrency(jsonResult[key].qmimi, 1)+"</td>"+
            "<td value='"+ jsonResult[key].qmimiAneks + "' class='td-body3'>"+toCurrency(jsonResult[key].qmimiAneks, 1)+"</td>"+
            "<td class='td-body'>"+toCurrency(totali, 1)+"</td></tr></tbody></table>");
            row_index = row_index + 1;
        }
        $("#red-flags-table-"+ year +" tr").each(function() {
            var indeksi = $( this ).attr('id');
            var vlera = $( this ).find(".td-body1").attr('value');
            var qmimi = $( this ).find(".td-body2").attr('value');
            var aneks = $( this ).find(".td-body3").attr('value');
            
            red_flags_number = redFlagConditions(indeksi, vlera, qmimi, aneks, redFlagTrackerArray);
            //console.log(index, red_flags_number);
            if(red_flags_number > 0) {
              var colorHex = getRedFlagHexColor(red_flags_number);
              $(this).find('td').css('background', colorHex);
            }
            // compare id to what you want
        });

        $('#results_' + year).append("<tfoot><tr><th class='td-foot' style=color: red;>Totali</th><th class='td-foot'></th><th style='font-size: 14px; font-weight:bold; width:450px;'></th><th class='td-foot'>"+ toCurrency(totali_vlera, 1) +"</th><th class='td-foot'>"+ toCurrency(totali_qmimi, 1) +"</th><th class='td-foot'>"+toCurrency(totali_aneks, 1)+"</th><th class='td-foot'>"+toCurrency(totali_total, 1)+"</th></tr></tfoot>");

        $('#red-flags-table-' + year).on('click', 'tr', function () {
          var rowIndex = $( this ).attr('id');
          if(redFlagTrackerArray[rowIndex] != undefined){
              var arrayLength = redFlagTrackerArray[rowIndex].length;
              console.log(redFlagTrackerArray[rowIndex]);
              var companyName = $('td', this).eq(0).text();

              $( "#jqueryUIRedFlag" ).dialog({
                 draggable: false,
                 autoOpen: false, 
                 resizable: false,
                 hide: "slide",
                 show : "slide",
                 position: {my: "top", at: "top+100", of: window},
                 closeOnEscape: true,
                 width: 700      
              });

              $("#jqueryUIRedFlag").empty();
            
              $( "#jqueryUIRedFlag" ).append('"Red Flags" për kompaninë: ' + companyName + ':');

              $( "#jqueryUIRedFlag" ).append('<ul>');
              for (var i = 0; i < arrayLength; i++) { 
                  $( "#jqueryUIRedFlag" ).append('<li>' + redFlagTrackerArray[rowIndex][i] + '</li>'); 
              }
              $( "#jqueryUIRedFlag" ).append('</ul>');

              $( "#jqueryUIRedFlag" ).dialog( "open" );
            } else {
              $("#jqueryUIRedFlag").empty();
            }
        });
      }

      
      function buildHtmlTable(jsonResult) {
        var redFlagTrackerArray = new Array();
        var totali = 0;
        var red_flags_number;
        var row_index = 0;
        $('#red-flags-list').empty();
        for ( var key in jsonResult ){
          totali = jsonResult[key].qmimi + jsonResult[key].qmimiAneks;
          $('#red-flags-list').append("<tr id='"+ row_index +"'>" +
            "<td class='td-body'>"+jsonResult[key].kompania+"</td>"+
            "<td class='td-body'>"+jsonResult[key].selia+"</td>"+
            "<td style='font-size: 14px; width:500px;'>"+jsonResult[key].pershkrimi+"</td>"+
            "<td value='"+ jsonResult[key].vlera + "' class='td-body1'>"+toCurrency(jsonResult[key].vlera, 1)+"</td>"+
            "<td value='"+ jsonResult[key].qmimi + "' class='td-body2'>"+toCurrency(jsonResult[key].qmimi, 1)+"</td>"+
            "<td value='"+ jsonResult[key].qmimiAneks + "' class='td-body3'>"+toCurrency(jsonResult[key].qmimiAneks, 1)+"</td>"+
            "<td class='td-body'>"+toCurrency(totali, 1)+"</td></tr>");
            row_index = row_index + 1;
        }

        $("#red-flags-list tr").each(function() {
            var indeksi = $( this ).attr('id');
            var vlera = $( this ).find(".td-body1").attr('value');
            var qmimi = $( this ).find(".td-body2").attr('value');
            var aneks = $( this ).find(".td-body3").attr('value');
            red_flags_number = redFlagConditions(indeksi, vlera, qmimi, aneks, redFlagTrackerArray);
            //console.log(index, red_flags_number);
            if(red_flags_number > 0) {
              var colorHex = getRedFlagHexColor(red_flags_number);
              $(this).find('td').css('background', colorHex);
            }
            // compare id to what you want
        });

        $('#red-flags-list').on('click', 'tr', function () {
          var rowIndex = $( this ).attr('id');
          if(redFlagTrackerArray[rowIndex] != undefined){
              var arrayLength = redFlagTrackerArray[rowIndex].length;
              console.log(redFlagTrackerArray[rowIndex]);
              var companyName = $('td', this).eq(0).attr('value');

              $( "#jqueryUIRedFlag" ).dialog({
                 draggable: false,
                 autoOpen: false, 
                 resizable: false,
                 hide: "slide",
                 show : "slide",
                 position: {my: "top", at: "top+100", of: window},
                 closeOnEscape: true,
                 width: 700      
              });

              $("#jqueryUIRedFlag").empty();
            
              $( "#jqueryUIRedFlag" ).append('"Red Flags" për kompaninë: ' + companyName + ':');

              $( "#jqueryUIRedFlag" ).append('<ul>');
              for (var i = 0; i < arrayLength; i++) { 
                  $( "#jqueryUIRedFlag" ).append('<li>' + redFlagTrackerArray[rowIndex][i] + '</li>'); 
              }
              $( "#jqueryUIRedFlag" ).append('</ul>');

              $( "#jqueryUIRedFlag" ).dialog( "open" );
            } else {
              $("#jqueryUIRedFlag").empty();
            }
        });
      }
</script>

<div id="container" style="padding-top:100px;padding-left:100px;padding-right:100px;">
  <div style="color:red;" align="center">
    <strong>Vërejtje:</strong> Hijëzimi me të kuqe nuk do të thotë që tenderi është i korruptuar por që përmbush kushtet e parapara për "red flag"
  </div>
  <br>
  <br>

  <div>
    <label class="redflagInfo" id="btn_red_flag_info">Çfarë janë "Red Flags" ?</label>
  </div>

  <form class="form-horizontal">
    <div class="form-group">
        <label for="viti-select" class="control-label col-xs-2">Viti:</label>
        <div class="col-xs-2">
          <select class="form-control" id="viti-select" name="viti-select">
            <option value="2010">2010</option>
            <option value="2011">2011</option>
            <option value="2012">2012</option>
            <option selected="selected" value="2013">2013</option>
            <option value="2014">2014</option>
          </select>
        </div>
    </div>
  </form>

  <div id="table">
  </div>

  <br>
  <br>
   <div id="jqueryUIRedFlag" title='Detajet e "Red Flags"'>
  </div>
  <div id="jqueryUI" title='Çfarë janë "Red Flags" ?'>
  </div>
</div>


{% endblock %}