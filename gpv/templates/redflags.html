{% extends "base.html" %}
{% block body %}

<script type="text/javascript" src="{{ url_for('static', filename='redFlags.js') }}"></script>
<script type="text/javascript">

      google.load("visualization", "1", {packages:["table"]});
       $(function() {
            
            $( "#jqueryUI" ).dialog({
               draggable: false,
               autoOpen: false, 
               resizable: false,
               hide: "slide",
               show : "slide",
               position: {my: "top", at: "top+100", of: window},
               closeOnEscape: true,
               width: 700      
            });
            
            $( "#btn_red_flag_info" ).click(function() {
                $( "#jqueryUI" ).empty();
                $( "#jqueryUI" ).append('Kontrata hijëzohet me të kuqe atëherë kur: ');

                $( "#jqueryUI" ).append('<ul>');
                for (var i = 0; i< redFlags.length; i++) {
                  $( "#jqueryUI" ).append('<li>' + redFlags[i] + '</li>');
                }
                $( "#jqueryUI" ).append('</ul>');

                $( "#jqueryUI" ).dialog( "open" );
            });
       });

      $(document).ready(function(){

        drawTable();

        $('#viti-select').change(function(){
          drawTable();
        })

        $('#diff-select').change(function(){
          drawTable();
        })
      })

      function drawTable() {
          var redFlagTrackerArray = new Array();

          var diff = $('#diff-select').val();
          var year = $('#viti-select').val();
          var url = '{{ config.BASE_PATH }}/json/{{ komuna }}/red-flags/'+ year;

          $.get(url, function(jsonResult){

            var data = new google.visualization.DataTable();
            data.addColumn('string', 'Kompania');
            data.addColumn('string', 'Aktiviteti');
            data.addColumn('number', 'Vlera e paraparë');
            data.addColumn('number', 'Vlera e kontraktuar');
            data.addColumn('number', 'Aneks');
            data.addColumn('number', 'Vlera e kontraktuar + Aneks');

            var totali = 0;
            for ( var key in jsonResult){
                totali = jsonResult[key].qmimi + jsonResult[key].qmimiAneks;

                data.addRow([jsonResult[key].kompania, jsonResult[key].pershkrimi, jsonResult[key].vlera, jsonResult[key].qmimi, jsonResult[key].qmimiAneks, totali]);
            }

            var rowInds = data.getNumberOfRows();
            for (var i = 0; i < rowInds; i++) {

              var vlera = data.getValue(i, 2);
              var qmimi = data.getValue(i, 3);
              var aneks = data.getValue(i, 4);
              var numberOfRedFlags = redFlagConditions(i, vlera, qmimi, aneks, redFlagTrackerArray);

              // Set the red flag color indicator for the current row.
              // The more red flags, the darker the color.          
              for (var j = 0; j <= 5; j++) {
                if(numberOfRedFlags > 0){
                    var colorHex = getRedFlagHexColor(numberOfRedFlags);
                      data.setProperty(i, j, 'style', 'font-size:14px; background-color:' + colorHex + ';');
                }
                else{
                    data.setProperty(i, j, 'style', 'font-size:14px;');
                }
              }
            }

            // Format numerical values into price format (e.g. 10000 -> €10,000)
            var formatter = new google.visualization.NumberFormat({
                fractionDigits: 2,
                prefix: '€'
            });

            for(var k=2; k <= 5; k++){
              formatter.format(data, k);
            }

            // draw table
            var table = new google.visualization.Table(document.getElementById('table_div'));

            var options = {'allowHtml': true};

            table.draw(data, options);

            // Hack to resolve CSS conflicts between googlecharts tabel and bootstrap
            $('.top-level').removeAttr('style');
            $($('.google-visualization-table-tr-head')[1]).remove();

            // Add onClick handler to get info on the red flags
            google.visualization.events.addListener(table, 'select', showRedFlagDetails);

            function showRedFlagDetails() {
              var selection = table.getSelection();
              var rowId = selection[0].row;

              if(redFlagTrackerArray[rowId] != undefined){

                var arrayLength = redFlagTrackerArray[rowId].length;
           
                var companyName = data.getValue(rowId, 0);

                $( "#jqueryUIRedFlag" ).dialog({
                   draggable: false,
                   autoOpen: false, 
                   resizable: false,
                   hide: "slide",
                   show : "slide",
                   position: {my: "top", at: "top+100", of: window},
                   closeOnEscape: true,
                   width: 700      
                });

                $("#jqueryUIRedFlag").empty();
              
                $( "#jqueryUIRedFlag" ).append('"Red Flags" për kompaninë: ' + companyName + ':');

                $( "#jqueryUIRedFlag" ).append('<ul>');
                for (var i = 0; i < arrayLength; i++) { 
                    $( "#jqueryUIRedFlag" ).append('<li>' + redFlagTrackerArray[rowId][i] + '</li>'); 
                }
                $( "#jqueryUIRedFlag" ).append('</ul>');

                $( "#jqueryUIRedFlag" ).dialog( "open" );
              }
            }          
        });
      }

      
</script>

<div id="container" style="padding-top:100px;padding-left:100px;padding-right:100px;">
  <div style="color:red;" align="center">
    <strong>Vërejtje:</strong> Hijëzimi me të kuqe nuk do të thotë që tenderi është i korruptuar por që përmbush kushtet e parapara për "red flag"
  </div>
  <br>
  <br>

  <div>
    <label class="redflagInfo" id="btn_red_flag_info">Çfarë janë "Red Flags" ?</label>
  </div>

  <form class="form-horizontal">
    <div class="form-group">
        <label for="viti-select" class="control-label col-xs-2">Viti:</label>
        <div class="col-xs-2">
          <select class="form-control" id="viti-select" name="viti-select">
            <option value="2010">2010</option>
            <option value="2011">2011</option>
            <option value="2012">2012</option>
            <option selected="selected" value="2013">2013</option>
            <option value="2014">2014</option>
          </select>
        </div>
    </div>
  </form>

  <div id="table_div">
  </div>

  <br>
  <br>

  <div id="jqueryUIRedFlag" title='Detajet e "Red Flags"'>
  </div>

  <div id="jqueryUI" title='Çfarë janë "Red Flags" ?'>
  </div>
</div>


{% endblock %}