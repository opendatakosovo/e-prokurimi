{% extends "base.html" %}
{% block body %}
<style type="text/css">
  .bigAndBoldClass{
    font-size: 15px;
    font-weight: bold;
    border-color: black;
    text-align: center;
  }
</style>
<script type="text/javascript">
      google.load("visualization", "1", {packages:["table"]});

      $(document).ready(function(){
        drawTable();

        $('#viti-select').change(function(){
          drawTable();
        })
      })

      function drawTable() {
          var year = $('#viti-select').val();
          var url = '{{ config.BASE_PATH }}/json/{{ komuna }}/company-list/'+ year;

          $.get(url, function(jsonResult){

          var data = new google.visualization.DataTable();
          data.addColumn('string', 'Emri i Kompanise');
          data.addColumn('string', 'Pershkrimi i aktivitetit');
          data.addColumn('number', 'Vlera');
          data.addColumn('number', 'Cmimi');
          data.addColumn('number', 'Aneks');


          for ( var key in jsonResult){
              data.addRow([jsonResult[key].kompania, jsonResult[key].pershkrimi, jsonResult[key].vlera, jsonResult[key].qmimi, jsonResult[key].qmimiAneks]);
          }

          var cssClassNames = {
              'headerRow': 'bigAndBoldClass'};

          var options = {'allowHtml': true, 'cssClassNames': cssClassNames};

          var rowInds = data.getNumberOfRows();
          for (var i = 0; i < rowInds; i++) {

            var numberOfRedFlags = 0;

            var vlera = data.getValue(i, 2);
            var qmimi = data.getValue(i, 3);
            var qmimi_str = qmimi.toString();

            // Check for red flag: vlera equals cmimi
            if(qmimi == vlera){
              numberOfRedFlags = numberOfRedFlags + 1;
            }

            // Check for red flag: cmimi is round number
            if (qmimi_str.length >= 6 && qmimi_str.substr(-5) == '00000'){
              numberOfRedFlags = numberOfRedFlags + 1;
            }
            else if (qmimi_str.length >= 5 && qmimi_str.substr(-4) == '0000'){
              numberOfRedFlags = numberOfRedFlags + 1;
            }
            else if (qmimi_str.length >= 4 && qmimi_str.substr(-3) == '000'){
              numberOfRedFlags = numberOfRedFlags + 1;
            }
            else if (qmimi_str.length >= 3 && qmimi_str.substr(-2) == '00'){
              numberOfRedFlags = numberOfRedFlags + 1;
            }
            else if (qmimi_str.length >= 2 && qmimi_str.substr(-1) == '0'){
              numberOfRedFlags = numberOfRedFlags + 1;
            }
            

            // Set the red flag color indicator for the current row.
            // The more red flags, the darker the color.
            
              for (var j = 0; j <= 4; j++) {
                if(numberOfRedFlags > 0){
                    var colorHex = getRedFlagHexColor(numberOfRedFlags);
                      data.setProperty(i, j, 'style', 'font-size:14px; background-color:' + colorHex + ';');
                }
                else{
                    data.setProperty(i, j, 'style', 'font-size:14px;');
                }
            }
          }


          var formatter = new google.visualization.NumberFormat({
                      fractionDigits: 0,
                      prefix: 'â‚¬'
                  });
          for(var k=2; k <= 4; k++){
            formatter.format(data, k);
          }
          var table = new google.visualization.Table(document.getElementById('table_div'));

          

          table.draw(data, options);

        })
      }

      function getRedFlagHexColor(numberOfRedFlags){
        var colorHex = '';

        if(numberOfRedFlags == 1){
          colorHex = '#fed976'; 
        }else if(numberOfRedFlags == 2){
          colorHex = '#feb24c'; 
        }else if(numberOfRedFlags == 3){
          colorHex = '#fd8d3c'; 
        }else if(numberOfRedFlags == 4){
          colorHex = '#fc4e2a'; 
        }else if(numberOfRedFlags == 5){
          colorHex = '#e31a1c'; 
        }else if(numberOfRedFlags == 6){
          colorHex = '#b10026'; 
        }
        return colorHex;
      }
</script>
<div id="select" style="text-align:center;">
  <label>Viti: </label>
  <select id="viti-select" style="width:100px; margin:0 auto 0 auto;" class="form-control">
    <option value="2011">2011</option>
    <option value="2012">2012</option>
    <option selected="selected" value="2013">2013</option>
    <option value="2014">2014</option>
  </select>
</div>
<br>
<div id="table_div">
  
</div>

{% endblock %}